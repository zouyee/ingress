{{ $cfg := .Cfg }}
{{ $backends := .Backends }}


worker_processes  1;

error_log  logs/error.log  debug;



events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    log_format  main  '{ "time": "$time_iso8601", "uri": "$request_uri", "method": "$request_method", "status": "$status", "lasttime": "$request_time", "token": "$token", "cluster": "$cluster", "namespace": "$namespace", "body": "$name"}';
    access_log  logs/access.log  main;

    sendfile        on;
    tcp_nopush     on;

    keepalive_timeout  65;

    client_header_buffer_size  4K;
    large_client_header_buffers     4 8k;
    client_body_buffer_size    60k;
    client_max_body_size 2m;
    client_body_in_single_buffer on;

    gzip  on;
    gzip_min_length 1k;
    gzip_buffers 4 16k;
    gzip_comp_level 2;
    gzip_types text/plain application/javascript text/css application/xml application/json image/jpeg image/gif image/png;
    gzip_vary off;

    lua_package_path '$prefix/conf/?.lua;;';

    init_by_lua '
        ngx.log(ngx.NOTICE, "Use auth module.")
        auth = require "auth"
    ';

    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # websocket config
    {{ range $k, $v := $backends.Cluster }}
      {{range $index, $endpoint := $v}}
      {{ if hasString $endpoint.Role "web-ssh"}}
    server {
        listen       8020;
        location /$k/ {
            proxy_pass http://{{ $endpoint.Address }}:8181/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }
    }
      {{ end }}
      {{ end }}
    {{ end }}

    server {
        listen       80;
        server_name  localhost;
        root /opt/k8s;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;
        lua_need_request_body on;
        set $token "";
        set $cluster "";
        set $namespace "";
        set $name "";
        if ( $http_cookie ~* "username=([A-Za-z0-9- ]*)" ){
             set $token $1;
        }
        if ( $http_cookie ~* "namespace=([A-Za-z0-9- ]*)" ){
             set $namespace $1;
        }
        if ( $http_cookie ~* "cluster=([A-Za-z0-9- ]*)"){
             set $cluster $1;
        }
        rewrite_by_lua '
            auth = require("auth")
            ngx.var.name = auth.get_name()
        ';

        location ~ ^/apis/cmss.com/v1/(login|verify|authchk) {
            proxy_set_header Host $http_host;
            proxy_pass http://{{ $cfg.Auth.Address }}:{{ $cfg.Auth.Port }}/apis/cmss.com/v1/$1$is_args$args;
        }
        location ~ ^/apis/cmss.com/v1/authority/user/(?<userid>.*)/conditions {
            proxy_set_header Host $http_host;
            proxy_pass http://{{ $cfg.Auth.Address }}:{{ $cfg.Auth.Port }}/apis/cmss.com/v1/authority/user/$userid/conditions$is_args$args;
        }

        
        location /apis/cmss.com/v1/ {
            access_by_lua 'auth.validate_token_and_authority()';
            proxy_set_header Host $http_host;
            proxy_pass http://{{ $cfg.Auth.Address }}:{{ $cfg.Auth.Port }}/apis/cmss.com/v1/;
        }


        {{ if hasString $cfg.Image.Role "alertmanager"}}
        location /image/ {
            proxy_set_header Host $http_host;
            proxy_pass http://{{ $cfg.Image.Address }}:{{ $cfg.Image.Port }}/;
        }
        {{ end }}

        {{ range $k, $v := $backends.Cluster }}
          {{range $index, $endpoint := $v}}
          {{ if hasString $endpoint.Role "alertmanager"}}
        location /$k/port9090/api/v1/ {
            proxy_set_header Host $http_host;
            proxy_pass http://{{ $endpoint.Address }}:9090/api/v1/;
        }

        location /$k/alert/ {
            proxy_set_header Host $http_host;
            proxy_pass http://10.142.21.152:9093/;
        }
        {{ end }}

        {{ if hasString $endpoint.Role "master"}}
        location /$k/conductor/api/v1/ {
            error_log  /var/log/nginx/error.log notice;
            access_by_lua 'auth.validate_token_and_authority()';
            proxy_set_header Host $http_host;
            proxy_pass http://{{ $endpoint.Address }}:30499/api/v1/;
        }
        {{ end }}
        {{ if hasString $endpoint.Role "resource-management"}}
        location /$k/resource/api/v1/ {
            access_by_lua 'auth.validate_token_and_authority()';
            proxy_set_header Host $http_host;
            proxy_pass http://{{ $endpoint.Address }}:32092/api/v1/;
        }
        {{ end }}
        {{ if hasString $endpoint.Role "es"}}
        location /$k/logmanage/ {
            access_by_lua 'auth.validate_token_and_authority()';
            proxy_set_header Host $http_host;
            proxy_pass http://10.142.21.167:9200/;
        }
        {{ end }}

        location /$k/dcos-metadata/nginx.tmpl {
            access_by_lua 'auth.validate_token_and_authority()';
            alias /opt/nginx.tmpl;
        }


        {{ end }}
        {{ end }}




        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

    }

}
