worker_processes  1;

error_log  logs/error.log  debug;

events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;

    log_format  main  '{ "time": "$time_iso8601", "uri": "$request_uri", "method": "$request_method", "status": "$status", "lasttime": "$request_time", "token": "$token", "cluster": "$cluster", "namespace": "$namespace", "body": "$name"}';
    access_log  logs/access.log  main;

    sendfile        on;
    tcp_nopush     on;

    keepalive_timeout  65;

    client_header_buffer_size  4K;
    large_client_header_buffers     4 8k;
    client_body_buffer_size    60k;
    client_max_body_size 2m;
    client_body_in_single_buffer on;

    gzip  on;
    gzip_min_length 1k;
    gzip_buffers 4 16k;
    gzip_comp_level 2;
    gzip_types text/plain application/javascript text/css application/xml application/json image/jpeg image/gif image/png;
    gzip_vary off;

    proxy_buffering on;
    proxy_buffer_size 16k;
    proxy_buffers 256 16k;

    lua_package_path '$prefix/conf/?.lua;;';

    init_by_lua '
        ngx.log(ngx.NOTICE, "Use auth module.")
        auth = require "auth"
    ';

    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # websocket config

    # conductor
      upstream defaultConductor {
          server 10.142.21.15:30499;
          server 10.142.21.15:30499;
          server 10.142.21.15:30499;
      }
      upstream minionsConductor {
      }
      upstream testConductor {
      }

    # resource-manager

      upstream defaultResource {
      }
      upstream minionsResource {
      }
      upstream testResource {
      }
    # log
      upstream defaultLog {
      }
      upstream minionsLog {
      }
      upstream testLog {
      }
    # monitor
    upstream defaultMonitor {
    }
      upstream defaultAlert {
      }
    upstream minionsMonitor {
    }
      upstream minionsAlert {
      }
    upstream testMonitor {
    }
      upstream testAlert {
      }

    server {
        listen       80;
        server_name  localhost;
        root /opt/k8s;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;
        lua_need_request_body on;
        set $token "";
        set $cluster "";
        set $namespace "";
        set $name "";
        if ( $http_cookie ~* "username=([A-Za-z0-9- ]*)" ){
             set $token $1;
        }
        if ( $http_cookie ~* "namespace=([A-Za-z0-9- ]*)" ){
             set $namespace $1;
        }
        if ( $http_cookie ~* "cluster=([A-Za-z0-9- ]*)"){
             set $cluster $1;
        }
        rewrite_by_lua '
            auth = require("auth")
            ngx.var.name = auth.get_name()
        ';

        location ~ ^/apis/cmss.com/v1/(login|verify|authchk) {
            proxy_set_header Host $http_host;
            proxy_pass http://10.142.21.201:2379/apis/cmss.com/v1/$1$is_args$args;
        }
        location ~ ^/apis/cmss.com/v1/authority/user/(?<userid>.*)/conditions {
            proxy_set_header Host $http_host;
            proxy_pass http://10.142.21.201:2379/apis/cmss.com/v1/authority/user/$userid/conditions$is_args$args;
        }
        location /apis/cmss.com/v1/ {
            access_by_lua 'auth.validate_token_and_authority()';
            proxy_set_header Host $http_host;
            proxy_pass http://10.142.21.201:2379/apis/cmss.com/v1/;
        }
        location /default/port9090/ {
            proxy_set_header Host $http_host;
            proxy_pass http://defaultMonitor/;
        }

        location /default/alert/ {
            proxy_set_header Host $http_host;
            proxy_pass http://defaultAlert/;
        }

        location /default/conductor/ {
            error_log  /var/log/nginx/error.log notice;
            access_by_lua 'auth.validate_token_and_authority()';
            proxy_set_header Host $http_host;
            proxy_pass http://defaultConductor/;
        }
        location /default/resource/api/v1/ {
            access_by_lua 'auth.validate_token_and_authority()';
            proxy_set_header Host $http_host;
            proxy_pass http://defaultResource/;
        }
        location /default/logmanage/ {
            access_by_lua 'auth.validate_token_and_authority()';
            proxy_set_header Host $http_host;
            proxy_pass http://defaultLog/;
        }
        location /minions/port9090/ {
            proxy_set_header Host $http_host;
            proxy_pass http://minionsMonitor/;
        }

        location /minions/alert/ {
            proxy_set_header Host $http_host;
            proxy_pass http://minionsAlert/;
        }

        location /minions/conductor/ {
            error_log  /var/log/nginx/error.log notice;
            access_by_lua 'auth.validate_token_and_authority()';
            proxy_set_header Host $http_host;
            proxy_pass http://minionsConductor/;
        }
        location /minions/resource/api/v1/ {
            access_by_lua 'auth.validate_token_and_authority()';
            proxy_set_header Host $http_host;
            proxy_pass http://minionsResource/;
        }
        location /minions/logmanage/ {
            access_by_lua 'auth.validate_token_and_authority()';
            proxy_set_header Host $http_host;
            proxy_pass http://minionsLog/;
        }
        location /test/port9090/ {
            proxy_set_header Host $http_host;
            proxy_pass http://testMonitor/;
        }

        location /test/alert/ {
            proxy_set_header Host $http_host;
            proxy_pass http://testAlert/;
        }

        location /test/conductor/ {
            error_log  /var/log/nginx/error.log notice;
            access_by_lua 'auth.validate_token_and_authority()';
            proxy_set_header Host $http_host;
            proxy_pass http://testConductor/;
        }
        location /test/resource/api/v1/ {
            access_by_lua 'auth.validate_token_and_authority()';
            proxy_set_header Host $http_host;
            proxy_pass http://testResource/;
        }
        location /test/logmanage/ {
            access_by_lua 'auth.validate_token_and_authority()';
            proxy_set_header Host $http_host;
            proxy_pass http://testLog/;
        }
        location /dcos-metadata/k8s-hosts.json {
            access_by_lua 'auth.validate_token_and_authority()';
            alias /opt/k8s-hosts.json;
        }

        location /dcos-metadata/nginx.tmpl {
            access_by_lua 'auth.validate_token_and_authority()';
            alias /opt/nginx.tmpl;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

    }

}
